<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1; minimum-scale=1; user-scalable=no;"> <meta content="How to manage AWS state file in a shared environment" name="description"> <meta name="keywords" content="Terraform, AWS, S3, shared, remote, backend "> <meta name="author" content="Andres Torres"> <meta name="baseurl" content=""> <title> Andres Torres|Shared Terraform State file </title> <!-- favicon --> <link rel="shortcut icon" href="/static/assets/img/favicon.ico"> <!-- Main CSS --> <link href="/static/assets/app-20180125.min.css" rel="stylesheet"> <link href="/static/css/custom.css" rel="stylesheet"> <!-- Main Scripts --> <script src="/static/assets/app-20180125.min.js"></script> <script src="/static/assets/blog-20180125.min.js"></script> <!-- Google AdSense --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-6196184668650108", enable_page_level_ads: true }); </script> </head> <body id="page-top" class="landing-page"> <div class="search-tool" style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right: 0px; opacity: 0.95; background-color: #111111; z-index: 9999; display: none;"> <input type="text" class="form-control search-content" id="search-content" style="position: fixed; top: 60px" placeholder="Search Blog"> <div style="position: fixed; top: 16px; right: 16px; z-index: 9999;"> <img src="/static/assets/img/search/cb-close.png" id="close-btn"/> </div> </div> <div style="position: fixed; right: 16px; bottom: 20px; z-index: 9999;"> <img src="/static/assets/img/search/cb-search.png" id="search-btn" title="Double click Ctrl"/> </div> <div class="navbar-wrapper"> <nav class="navbar navbar-default navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header page-scroll"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/">Andres Torres</a> </div> <div id="navbar" class="navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li><a class="page-scroll" href="blog/"></a></li> <li> <a class="page-scroll" href="/blog/">Blog</a></li> <li> <a class="page-scroll" href="/aws/">AWS</a></li> <li> <a class="page-scroll" href="/linux/">Linux</a></li> <li> <a class="page-scroll" href="/jenkins/">Jenkins</a></li> <li> <a class="page-scroll" href="/docker/">Docker</a></li> <li> <a class="page-scroll" href="/vagrant/">Vagrant</a></li> <li> <a class="page-scroll" href="/chef/">Chef</a></li> <li> <a class="page-scroll" href="/terraform/">Terraform</a></li> <li> <a class="page-scroll" href="/ansible/">Ansible</a></li> <li> <a class="page-scroll" href="/life/">Others</a></li> </ul> </div> </div> </nav> </div> <div id="inSlider" class="carousel carousel-fade" data-ride="carousel"> <ol class="carousel-indicators"> <li data-target="#inSlider" data-slide-to="0" class="active"></li> <li data-target="#inSlider" data-slide-to="1"></li> </ol> <div class="carousel-inner" role="listbox"> <div class="item active"> <div class="container"> <div class="carousel-caption"> </div> <div class="carousel-image wow zoomIn"> <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> --> </div> </div> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/static/assets/img/landing/prog.jpg);" title="first banner image"> </div> </div> <div class="item"> <div class="container"> <div class="carousel-caption"> </div> <div class="carousel-image wow zoomIn"> <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> --> </div> </div> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/static/assets/img/landing/prog2.jpg);" title="2nd banner image"></div> </div> <div class="item"> <div class="container"> <div class="carousel-caption"> </div> <div class="carousel-image wow zoomIn"> <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> --> </div> </div> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/static/assets/img/landing/prog3.jpg);" title="3rd banner image"></div> </div> <div class="item"> <div class="container"> <div class="carousel-caption"> </div> <div class="carousel-image wow zoomIn"> <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> --> </div> </div> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/static/assets/img/landing/prog6.jpg);" title="4th banner image"></div> </div> </div> <a class="left carousel-control" href="#inSlider" role="button" data-slide="prev"> <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> <span class="sr-only">Previous</span> </a> <a class="right carousel-control" href="#inSlider" role="button" data-slide="next"> <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span> <span class="sr-only">Next</span> </a> </div> <div class="wrapper wrapper-content animated fadeInRight article"> <div class="row"> <div class="col-lg-10 col-lg-offset-1"> <div class="ibox"> <div class="ibox-content"> <div class="pull-right"> <a class="btn btn-white btn-xs" href="/aws">Aws</a> </div> <div class="text-center article-title"> <span class="text-muted"><i class="fa fa-clock-o"></i> 20 Nov 2018</span> <h1> Shared Terraform State file </h1> </div> <p><em>Note (2025): Backend concept and workspaces are unchanged. For current syntax and options (e.g. S3 state locking, bucket versioning), see the <a href="https://developer.hashicorp.com/terraform/language/settings/backends/s3">official S3 backend docs</a>.</em></p> <p>Probably you are not familiarized with the infrastructure state concept: it’s a snapshot of what we have configured and running in our current infrastructure <strong>(VPCs, Subnets, Instances, RDS, Volumes, etc)</strong>, this snapshot help us to update our infrastructure allowing us to run our scripts and applying just the changes that we have, this snapshot is what provide us idempotence in IT architecture creation.</p> <p>Now, let’s say that we have a git repo with our terraform scripts, those scripts creates a VPC, two subnets and two instances one inside each subnet, this git repo has collaborators that can execute the deploy when they want; but, what happen with that <strong>state file</strong>?; that state file cannot be stored in git because is a file that has sensitive info about our architecture and it changes quite often.</p> <p>So, we have an issue here, what would happen if two collaborators apply their changes without share their <strong>state file</strong>?. We will have infrastructure consistency errors because some changes will be executed before other and you could delete the changes made by another collaborator.</p> <p>then, What can we do?</p> <p>In this scenario, Terraform provides a remote state feature called <a href="https://developer.hashicorp.com/terraform/language/settings/backends/s3"><strong>backends</strong></a>, which keeps the state file updated with every run.</p> <p>Now what would happen if you want to test your changes without change the develop or QA or even production environment? In this scenario we could use a simple Terraform tool called <strong>workspaces</strong>, this workspaces will allow us to create different environments that will have their own state file.</p> <p>This workspace will not block the write over a state file, just will give us the chance to work with different state files and different stacks.</p> <p>To work with this configuration follow the next steps:</p> <ol> <li> <p>Create an account with S3 access</p> </li> <li> <p>Create bucket for save terraform.tfstate files</p> </li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>YOUR-BUCKET-NAME
</code></pre></div></div> <ol> <li> <p>Once we have the bucket created we need to configure it to save the terraform state files.</p> </li> <li> <p>Create your <code class="language-plaintext highlighter-rouge">main.tf</code> and <code class="language-plaintext highlighter-rouge">variable.tf</code> files with your provider and bucket definition. Note: the backend block cannot use variables, so the region is hardcoded below. Enable <strong>bucket versioning</strong> on the S3 bucket (in the AWS console) so you can recover state if needed. Optionally set <code class="language-plaintext highlighter-rouge">use_lockfile = true</code> in the backend for state locking.</p> </li> </ol> <p><code class="language-plaintext highlighter-rouge">main.tf</code></p> <div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">region</span>
<span class="p">}</span>

<span class="nx">terraform</span> <span class="p">{</span>
  <span class="nx">backend</span> <span class="s2">"s3"</span> <span class="p">{</span>
    <span class="nx">bucket</span>         <span class="o">=</span> <span class="s2">"YOUR-BUCKET-NAME"</span>
    <span class="nx">key</span>            <span class="o">=</span> <span class="s2">"terraform.tfstate"</span>
    <span class="nx">region</span>         <span class="o">=</span> <span class="s2">"us-west-1"</span>
    <span class="nx">encrypt</span>        <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">use_lockfile</span>   <span class="o">=</span> <span class="kc">true</span>   <span class="c1"># optional: S3-based state locking</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">variables.tf</code></p> <div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">variable</span> <span class="s2">"region"</span> <span class="p">{</span>
  <span class="nx">default</span> <span class="o">=</span> <span class="s2">"us-west-1"</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"environment"</span> <span class="p">{</span>
  <span class="nx">default</span> <span class="o">=</span> <span class="s2">"dev"</span>
<span class="p">}</span>
</code></pre></div></div> <ol> <li>Initialize your backend. Prefer <strong>environment variables</strong> for credentials so they are not stored under <code class="language-plaintext highlighter-rouge">.terraform</code> or in plan files:</li> </ol> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">"&lt;YOUR ACCESS KEY&gt;"</span>
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">"&lt;YOUR SECRET KEY&gt;"</span>
<span class="nb">export </span><span class="nv">AWS_REGION</span><span class="o">=</span><span class="s2">"us-west-1"</span>

terraform init
</code></pre></div></div> <p>If you need to override only non-sensitive backend settings (e.g. bucket or key) without changing the config file:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform init <span class="nt">-backend-config</span><span class="o">=</span><span class="s2">"bucket=YOUR-BUCKET-NAME"</span> <span class="nt">-backend-config</span><span class="o">=</span><span class="s2">"key=terraform.tfstate"</span>
</code></pre></div></div> <ol> <li>Add the workspaces to use</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform workspace new dev
terraform workspace new prod
terraform workspace new YOUR-WORKSPACE-NAME
</code></pre></div></div> <ol> <li>Select the workspace to use</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform workspace use dev
</code></pre></div></div> <ol> <li>Run plan and apply with the vars file for the environment</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform plan -var-file="variables_dev.tfvars"
terraform apply -var-file="variables_dev.tfvars"
</code></pre></div></div> <hr> <div class="row"> <div class="col-md-6"> <h5 style="display: inline;">Tags:</h5> <button class="btn btn-white btn-xs" type="button">terraform</button> <button class="btn btn-white btn-xs" type="button">AWS</button> <button class="btn btn-white btn-xs" type="button">S3</button> <button class="btn btn-white btn-xs" type="button">Backend</button> </div> <div class="col-md-6"> <div class="small text-right"> <div> </div> </div> </div> </div> <br> <div class="row"> <div class="col-lg-12"> <!-- donate --> <br> <!-- share --> <div class="a2a_kit a2a_kit_size_32 a2a_default_style"> <a class="a2a_dd" href="https://www.addtoany.com/share"></a> <a class="a2a_button_facebook"></a> <a class="a2a_button_twitter"></a> <a class="a2a_button_google_plus"></a> <a class="a2a_button_linkedin"></a> <a class="a2a_button_email"></a> <a class="a2a_button_wechat"></a> <a class="a2a_button_sina_weibo"></a> <a class="a2a_button_pocket"></a> </div> <script> var a2a_config = a2a_config || {}; a2a_config.color_main = "D7E5ED"; a2a_config.color_border = "AECADB"; a2a_config.color_link_text = "333333"; a2a_config.color_link_text_hover = "333333"; </script> <script async src="https://static.addtoany.com/menu/page.js"></script> <br> <!-- comment --> </div> </div> </div> </div> </div> </div> </div> <!-- Google analytics --> <!-- GrowingIO --> </body> </html>
